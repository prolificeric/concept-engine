var j=Object.defineProperty;var tt=e=>j(e,"__esModule",{value:!0});var O=(e,t)=>{tt(e);for(var r in t)j(e,r,{get:t[r],enumerable:!0})};O(exports,{Concept:()=>s,NULL_CONCEPT:()=>g,astToTokenTree:()=>J,createTemplate:()=>ot,extractVariables:()=>N,filterUniqueConcepts:()=>P,getConceptsDeep:()=>$,getPatternMatches:()=>it,getPatternVariables:()=>Y,interpolate:()=>Q,interpolateToConcept:()=>b,interpolateToConcepts:()=>X,isAtom:()=>x,isCompound:()=>T,isPattern:()=>f,isTextBlock:()=>et,isVariable:()=>d,parseConcept:()=>y,parseConcepts:()=>D,toConcept:()=>nt,toConcepts:()=>k,tokenTreeToConcept:()=>I});var U=(e,t)=>{let r=[],n={offset:0,line:1,column:1},o=c=>{for(let a of t){let p=a.match(c);if(p){let u=p.split(`
`),m={offset:n.offset+p.length,line:n.line+u.length-1,column:u.length>0?u.slice(-1)[0].length:n.column+p.length};return{kind:a,loc:{start:n,end:m,source:p}}}}return null},i=e;for(;i.length>0;){let c=o(i);if(!c)throw new Error(`Unknown input starting at line ${n.line}, column ${n.column}`);r.push(c),n=c.loc.end,i=i.slice(c.loc.source.length)}return r},l=(e,t)=>({name:e,match:r=>(t.exec(r)||[])[0]}),h=class extends Error{constructor(t,r){let{line:n,column:o}=r.loc.start;super(`${t instanceof Error?t.message:"message"} (line ${n}, column ${o})`);this.token=r}};var s=class{constructor(t){let r=t.parts||[];r.length===1&&(r=r[0].parts);let n=r.length>0?s.join(r):t.key||"";this.key=n,this.parts=r}getShape(){if(this.parts.length===0)return 0;let t=this.parts.map(r=>r.getShape());return t.every(r=>r===0)?t.length:t}static createAtom(t){return new s({key:t})}static createCompound(t){return new s({parts:t.map(r=>Array.isArray(r)?s.createCompound(r):r instanceof s?r:s.createAtom(r))})}static join(t){return t.map(r=>r.parts.length>=2?`[${r.key}]`:r.key).join(" ")}toString(){return this.key}},g=s.createAtom(""),P=e=>{let t=new Map;return e.forEach(r=>t.set(r.key,r)),Array.from(t.values())},$=e=>{let t=new Map;return e.forEach(r=>{t.set(r.key,r),$(r.parts).forEach(n=>{t.set(n.key,n)})}),Array.from(t.values())},x=e=>e.parts.length===0,d=e=>x(e)&&e.key[0]==="$",f=e=>T(e)&&e.parts.some(t=>d(t)||f(t)),T=e=>e.parts.length>1,et=e=>e.key.slice(0,2)+e.key.slice(-2)==="<<>>";var z=(e,t)=>e.length===0?t:t.length===0?e:e.flatMap(r=>t.map(n=>[...r,...n])),G=(e,t)=>{e.forEach((r,n)=>{t({item:e[n],prev:e[n-1],next:e[n+1],prevAll:function*(){for(let o=n-1;o>=0;o-=1)yield e[o];return null},nextAll:function*(){for(let o=n+1;o<e.length;o+=1)yield e[o];return null}})})};var W=(e,t)=>{let r=new Map;return e.forEach(n=>{r.set(t(n),n)}),Array.from(r.values())};var M={};O(M,{AtomKind:()=>C,CommaKind:()=>V,CurlyLeftKind:()=>A,CurlyRightKind:()=>K,NewlineSeparatorKind:()=>S,ParenLeftKind:()=>E,ParenRightKind:()=>w,SemicolonKind:()=>v,SquareLeftKind:()=>R,SquareRightKind:()=>B,WhitespaceKind:()=>rt});var S=l("NewlineSeparator",/^([ \t]*\n[ \t]*)+/),rt=l("Whitespace",/^[ \t]+/),A=l("CurlyLeft",/^\{/),K=l("CurlyRight",/^\}/),R=l("SquareLeft",/^\[/),B=l("SquareRight",/^\]/),E=l("ParenLeft",/^\(/),w=l("ParenRight",/^\)/),V=l("ParenRight",/^,/),v=l("ParenRight",/^;/),C=l("Atom",/^<<(.|\n)+?>>|^[^ \n\t\{\}\[\]\(\)\,\;]+/);var L=class{constructor(){let t={type:"Permutation",children:[]},r={type:"Root",children:[t]};this.context={permutation:t,block:r},this.root=r}end(){let t=this.context;for(;t;)this.terminatePermutation(),t=t.parent;return this}terminatePermutation(){return this.context.permutation.children.length===0&&this.context.block.children.pop(),this}consumeAtomToken(t){if(t.kind!==C)throw new h("Token must be an Atom",t);let r={token:t,type:"Atom",text:t.loc.source};return this.context.permutation.children.push(r),this}nextPermutation(){this.terminatePermutation();let t={type:"Permutation",children:[]};return this.context.block.children.push(t),this.context.permutation=t,this}startPermutationBlock(t){let r={type:"Permutation",children:[]},n={type:t,children:[r]};return this.context.permutation.children.push(n),this.context={block:n,permutation:r,parent:this.context},this}endPermutationBlock(){let{parent:t}=this.context;if(!t)throw new Error("Unexpected block ending");return this.terminatePermutation(),this.context=this.context.parent,this}};var F=e=>{let t=new L;return G(e,({item:r})=>{try{switch(r.kind){case C:t.consumeAtomToken(r);break;case A:t.startPermutationBlock("PermutationBlock");break;case K:t.endPermutationBlock();break;case R:t.startPermutationBlock("EmbeddedPermutationBlock");break;case B:t.endPermutationBlock();break;case E:t.startPermutationBlock("ParentheticalPermutationBlock");break;case w:t.endPermutationBlock();break;case V:t.nextPermutation();break;case v:t.nextPermutation();break;case S:t.nextPermutation();break;default:break}}catch(n){throw new h(n,r)}}),t.end().root};var H=e=>{if(x(e))return e;let[t,...r]=e.parts,n=!1,o=c=>T(c)?s.createCompound(c.parts.map(o)):c.key==="&"?(n=!0,t):c,i=r.map(o);return n?s.createCompound(i):e},q=e=>{if(x(e))return e;let[t,...r]=e.parts.map(q);if(t.key!==":")return e;let n=r.sort((o,i)=>o.key.localeCompare(i.key));return s.createCompound([t,...n])};var D=e=>{e=Array.isArray(e)?e.join(`
`):e;let t=U(e,Object.values(M)),r=F(t),n=J(r);return P(n.map(I))},y=e=>D(e)[0]||g,nt=e=>e instanceof s?e:s.createAtom(e),k=e=>Array.isArray(e)?e.flatMap(k):e instanceof s?[e]:D(e),I=e=>{if(e.length===0)return null;let t=n=>{let o=n.map(i=>Array.isArray(i)?t(i):s.createAtom(i.loc.source)).filter(Boolean);return o.length===1?o[0]:s.createCompound(o)},r=t(e);return q(H(r))},J=e=>{let t=[],r=(o,i=[])=>{switch(o.type){case"Atom":return[[o.token]];case"TextBlock":return[[o.token]];case"Root":return o.children.flatMap(a=>r(a,[]));case"PermutationBlock":return o.children.flatMap(a=>r(a,[]));case"ParentheticalPermutationBlock":return o.children.forEach(a=>{let p=z(i,r(a));t.push(...p)}),[];case"EmbeddedPermutationBlock":return o.children.flatMap(a=>r(a,[]).map(p=>[p]));case"Permutation":{let c=o,a=[],p=[];return c.children.forEach(u=>{let m=r(u,p);a.length===0?a=m:m.length>0&&(a=a.flatMap(Z=>m.map(_=>[...Z,..._]))),p=m}),a}default:throw new Error("Unhandled AST node type: "+o.type)}};return[...r(e),...t]};var ot=e=>{let t=k(e),r=X.bind(null,t);return{patterns:t,interpolate:r}},it=(e,t)=>{let r=[];return e.forEach(n=>{let o=n.parts.length;t.filter(i=>i.parts.length===o&&i.key!==n.key).forEach(i=>{let c=N(i,n);c&&r.push({pattern:n,concept:i,variables:c})})}),r},Q=(e,t)=>typeof e=="string"?Q(y(e),t):b(e,t).key,b=(e,t)=>(typeof e=="string"&&(e=y(e)),f(e)?s.createCompound(e.parts.map(r=>b(r,t))):t[e.key]?k(t[e.key])[0]:e),X=(e,t)=>{let r=k(e),n={};Object.entries(t).forEach(([i,c])=>{n[i]=k(c)});let o=Object.entries(n).reduce((i,[c,a])=>a.flatMap(p=>i.map(u=>b(u,{[c]:p}))),r);return W(o,i=>i.key)},N=(e,t)=>{let r=t.parts.length;if(e.parts.length!==r)return null;let n={};for(let o=0;o<r;o+=1){let i=e.parts[o],c=t.parts[o];if(d(c)){let a=c.key,p=n[a];if(p&&p.key!==i.key)return null;n[a]=i}else if(f(c)){let a=N(i,c);if(!a)return null;for(let[p,u]of Object.entries(a)){let m=n[p];if(m&&m.key!==u.key)return null;n[p]=u}}else if(i.key!==c.key)return null}return n},Y=(...e)=>{let t=new Map;return e.flat().forEach(r=>{d(r)?t.set(r.key,r):f(r)&&Y(r.parts).forEach(n=>{t.set(n.key,n)})}),Array.from(t.values())};0&&(module.exports={Concept,NULL_CONCEPT,astToTokenTree,createTemplate,extractVariables,filterUniqueConcepts,getConceptsDeep,getPatternMatches,getPatternVariables,interpolate,interpolateToConcept,interpolateToConcepts,isAtom,isCompound,isPattern,isTextBlock,isVariable,parseConcept,parseConcepts,toConcept,toConcepts,tokenTreeToConcept});
